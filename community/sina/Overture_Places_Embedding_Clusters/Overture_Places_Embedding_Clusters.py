@fused.udf
def udf_h3_embedding(h3_index="894509b022bffff", h3_size=8):
    import geopandas as gpd
    import h3
    import pandas as pd
    from shapely.geometry import Polygon
    from sklearn.feature_extraction.text import CountVectorizer


    # 1. Polygon from H3
    polygon = Polygon([coord[::-1] for coord in h3.cell_to_boundary(h3_index)])

    # 2. Load Overture Places
    udf = fused.load("https://github.com/fusedio/udfs/tree/2ea46f3/public/Overture_Maps_Example/")
    gdf = fused.run(udf, bounds=polygon.bounds, overture_type="place")

    # 3. Normalize the 'categories' column into individual columns
    categories_df = pd.json_normalize(gdf["categories"]).reset_index(drop=True)
    categories_df.rename(columns={"primary": "categories_primary"}, inplace=True)
    names_df = pd.json_normalize(gdf["names"]).reset_index(drop=True)
    names_df.rename(columns={"primary": "names_primary"}, inplace=True)

    # 4. Concatenate the new columns back into the original GeoDataFrame
    gdf2 = pd.concat(
        [
            gdf.drop(columns=["categories", "names"]).reset_index(),
            categories_df,
            names_df,
        ],
        axis=1,
    )
    gdf2["h3_index"] = gdf2.geometry.apply(
        lambda p: h3.latlng_to_cell(p.y, p.x, h3_size)
    )

    # 5. Group by H3, create categories primary set
    gdf3 = gdf2.dissolve(
        by="h3_index",
        as_index=False,
        aggfunc={
            "categories_primary": lambda x: list([y for y in set(x) if pd.notna(y)])
        },
    )

    # 6. Convert matrix to a list of embeddings (dense vectors)
    vectorizer = CountVectorizer(
        vocabulary=global_categories
    )  # Align with the same feature space (for consistent vocabulary)
    gdf3["embedding"] = gdf3["categories_primary"].apply(
        lambda x: vectorizer.transform([" ".join(x)]).toarray()[0].tolist()
    )
    return gdf3


import geopandas as gpd

# CDMX
aoi = gpd.GeoDataFrame.from_features(
    {
        "type": "FeatureCollection",
        "features": [
            {
                "type": "Feature",
                "properties": {},
                "geometry": {
                    "coordinates": [
                        [
                            [-99.1384892195269, 19.59152906611483],
                            [-99.17550402024722, 19.555179600313224],
                            [-99.17758936113303, 19.52717510080535],
                            [-99.22398819583992, 19.52324425606041],
                            [-99.2417135933678, 19.425433760674025],
                            [-99.20730546875396, 19.381670285340377],
                            [-99.22711620716832, 19.310837062987176],
                            [-99.1989641052113, 19.28082206107021],
                            [-99.14787325351213, 19.27688525915849],
                            [-99.07801433384182, 19.275901043897136],
                            [-99.04412754444925, 19.339862725832745],
                            [-99.01806078337803, 19.452472714593014],
                            [-99.00346339717856, 19.567460742295196],
                            [-99.1384892195269, 19.59152906611483],
                        ]
                    ],
                    "type": "Polygon",
                },
            }
        ],
    }
)
# Merida
# aoi = gpd.GeoDataFrame.from_features({"type":"FeatureCollection","features":[{"type":"Feature","properties":{},"geometry":{"coordinates":[[[-89.76893755755052,21.117823115480732],[-89.76893755755052,20.82720703395323],[-89.47067057006947,20.82720703395323],[-89.47067057006947,21.117823115480732],[-89.76893755755052,21.117823115480732]]],"type":"Polygon"}}]})
# Leon
# aoi = gpd.GeoDataFrame.from_features({"type":"FeatureCollection","features":[{"type":"Feature","properties":{},"geometry":{"coordinates":[[[-101.77430478747662,21.203654701096255],[-101.77430478747662,21.058658735343457],[-101.57371795831008,21.058658735343457],[-101.57371795831008,21.203654701096255],[-101.77430478747662,21.203654701096255]]],"type":"Polygon"}}]})


@fused.udf
def udf(bounds: fused.types.Bounds = None, h3_size=8):
    # we are using the aoi as the bounds, so no default params in this UDF
    import duckdb
    import geopandas as gpd
    import h3
    import numpy as np
    import pandas as pd
    from sklearn.cluster import KMeans
    from sklearn.metrics.pairwise import cosine_similarity


    # convert bounds to tile
    common = fused.load("https://github.com/fusedio/udfs/tree/b7637ee/public/common/")
    tile = common.get_tiles(bounds, clip=True) if bounds is not None else aoi

    # 1. Polyfill AOI
    h3s = h3.polygon_to_cells(h3.geo_to_h3shape(tile.geometry.iloc[0]), h3_size)

    @fused.cache
    def run_udfs(h3_index):
        try:
            gdf = fused.run(
                udf_h3_embedding, h3_index=h3_index, h3_size=h3_size, engine="local"
            )
            gdf["h3_index"] = h3_index
            gdf.insert(0, "h3_index", gdf.pop("h3_index"))
            return gdf
        except Exception as e:
            print(e)

    # 2. Run Embeddings UDF for each H3 cell
    gdfs = common.run_pool(run_udfs, h3s, max_workers=100)
    # Filter out failed outputs
    gdfs = [gdf for gdf in gdfs if gdf is not None]
    if len(gdfs) == 0:
        return None

    gdf = pd.concat(gdfs)

    embeddings = gdf.embedding.tolist()

    # 3. Cluster using KMeans
    kmeans = KMeans(n_clusters=min(len(embeddings), 6), random_state=42)
    gdf["cluster"] = kmeans.fit_predict(embeddings)

    # 4. Describe each cluster
    category_rows = []
    for idx, row in gdf.iterrows():
        # Filter categories with non-zero embedding indices
        selected_categories = np.array(global_categories)[
            np.array(row["embedding"]) == 1
        ]
        for category in selected_categories:
            category_rows.append({"cluster": row["cluster"], "category": category})

    # 5. Structure output table
    category_df = pd.DataFrame(category_rows)
    category_counts = (
        category_df.groupby(["cluster", "category"]).size().reset_index(name="count")
    )
    category_arrays = (
        category_counts.groupby("cluster")
        .apply(lambda x: x.nlargest(5, "count")["category"].tolist())
        .reset_index(name="top_categories")
    )
    gdf = gdf[["h3_index", "cluster"]].merge(category_arrays, on="cluster", how="left")

    print("Cluster descriptions:")
    print(category_counts)
    print(category_arrays)

    return gdf[["h3_index", "cluster", "top_categories"]]


global_categories = [
    "meditation_center",
    "hair_supply_stores",
    "vocational_and_technical_school",
    "auto_company",
    "zoo",
    "lottery_ticket",
    "wedding_planning",
    "soup_restaurant",
    "towing_service",
    "gift_shop",
    "newspaper_and_magazines_store",
    "fountain",
    "automotive_repair",
    "linen",
    "sewing_and_alterations",
    "insurance_agency",
    "landscaping",
    "shopping",
    "football_stadium",
    "obstetrician_and_gynecologist",
    "notary_public",
    "pancake_house",
    "agriculture",
    "cocktail_bar",
    "fast_food_restaurant",
    "firework_retailer",
    "motorcycle_dealer",
    "health_and_medical",
    "cafetaria",
    "department_store",
    "restaurant_equipment_and_supply",
    "adult_entertainment",
    "community_center",
    "tutoring_center",
    "hindu_temple",
    "health_department",
    "magician",
    "butcher_shop",
    "general_litigation",
    "book_magazine_distribution",
    "party_supply",
    "hobby_shop",
    "wig_store",
    "pediatric_dentist",
    "cosmetic_dentist",
    "water_supplier",
    "radio_station",
    "theatrical_productions",
    "professional_sports_team",
    "paint_store",
    "astrologer",
    "attractions_and_activities",
    "local_and_state_government_offices",
    "music_and_dvd_store",
    "resort",
    "airlines",
    "software_development",
    "venue_and_event_space",
    "employment_agencies",
    "agricultural_cooperatives",
    "plastic_surgeon",
    "car_dealer",
    "aromatherapy",
    "aquarium",
    "clinical_laboratories",
    "wholesale_grocer",
    "pool_cleaning",
    "spanish_restaurant",
    "halfway_house",
    "dental_supply_store",
    "web_designer",
    "research_institute",
    "carpet_store",
    "dentist",
    "sporting_goods",
    "audio_visual_equipment_store",
    "spas",
    "criminal_defense_law",
    "music_school",
    "noodles_restaurant",
    "speakeasy",
    "party_and_event_planning",
    "race_track",
    "asian_restaurant",
    "talent_agency",
    "public_and_government_association",
    "key_and_locksmith",
    "engine_repair_service",
    "bubble_tea",
    "costume_store",
    "photography_museum",
    "choir",
    "bags_luggage_company",
    "escape_rooms",
    "construction_services",
    "graphic_designer",
    "lingerie_store",
    "music_production",
    "professional_sports_league",
    "college_university",
    "television_service_providers",
    "automotive",
    "patio_covers",
    "business_advertising",
    "home_service",
    "barbecue_restaurant",
    "souvenir_shop",
    "b2b_apparel",
    "financial_service",
    "storage_facility",
    "vegetarian_restaurant",
    "furniture_manufacturers",
    "funeral_services_and_cemeteries",
    "arcade",
    "pawn_shop",
    "endodontist",
    "gardener",
    "beach",
    "ip_and_internet_law",
    "mountain",
    "swimwear_store",
    "bookstore",
    "truck_repair",
    "b2b_textiles",
    "fishmonger",
    "real_estate_law",
    "interior_design",
    "counseling_and_mental_health",
    "glass_manufacturer",
    "appliance_store",
    "media_news_website",
    "laboratory",
    "supermarket",
    "taxi_service",
    "real_estate_agent",
    "freight_and_cargo_service",
    "nail_salon",
    "mattress_store",
    "jehovahs_witness_kingdom_hall",
    "medical_center",
    "patisserie_cake_shop",
    "gas_station",
    "clothing_company",
    "home_cleaning",
    "shoe_repair",
    "topic_publisher",
    "natural_hot_springs",
    "asian_art_museum",
    "home_developer",
    "chocolatier",
    "recycling_center",
    "cave",
    "distillery",
    "pop_up_shop",
    "ambulance_and_ems_services",
    "family_practice",
    "tire_dealer_and_repair",
    "russian_restaurant",
    "jewelry_store",
    "travel_agents",
    "surgical_appliances_and_supplies",
    "flowers_and_gifts_shop",
    "pet_store",
    "transportation",
    "business_office_supplies_and_stationery",
    "electric_utility_provider",
    "private_association",
    "industrial_company",
    "contractor",
    "educational_supply_store",
    "paintball",
    "printing_services",
    "general_dentistry",
    "psychic",
    "beer_garden",
    "dance_school",
    "amateur_sports_team",
    "political_party_office",
    "limo_services",
    "charity_organization",
    "sports_and_fitness_instruction",
    "chemical_plant",
    "central_government_office",
    "trailer_dealer",
    "pool_billiards",
    "sikh_temple",
    "mortgage_broker",
    "fence_and_gate_sales_service",
    "record_label",
    "business_management_services",
    "tapas_bar",
    "dance_club",
    "health_food_restaurant",
    "piercing",
    "bakery",
    "massage_school",
    "children's_clothing_store",
    "karaoke",
    "commercial_real_estate",
    "candy_store",
    "steakhouse",
    "mass_media",
    "dry_cleaning",
    "archaeological_services",
    "security_services",
    "frozen_yoghurt_shop",
    "uniform_store",
    "maternity_wear",
    "medical_service_organizations",
    "travel_company",
    "information_technology_company",
    "chinese_restaurant",
    "b2b_electronic_equipment",
    "environmental_conservation_organization",
    "lighting_store",
    "hot_dog_restaurant",
    "courthouse",
    "home_health_care",
    "mattress_manufacturing",
    "train_station",
    "appliance_manufacturer",
    "janitorial_services",
    "day_spa",
    "electronics",
    "energy_company",
    "internet_cafe",
    "merchandising_service",
    "eyewear_and_optician",
    "media_restoration_service",
    "fire_protection_service",
    "grocery_store",
    "beer_wine_and_spirits",
    "dog_walkers",
    "chiropractor",
    "catholic_church",
    "fabric_store",
    "sri_lankan_restaurant",
    "bowling_alley",
    "lebanese_restaurant",
    "cycling_classes",
    "candle_store",
    "health_food_store",
    "desserts",
    "diagnostic_imaging",
    "salad_bar",
    "telemarketing_services",
    "it_service_and_computer_repair",
    "wholesale_store",
    "game_publisher",
    "casino",
    "cultural_center",
    "yoga_studio",
    "liquor_store",
    "lumber_store",
    "diagnostic_services",
    "food_truck",
    "car_stereo_store",
    "middle_eastern_restaurant",
    "damage_restoration",
    "boot_camp",
    "synagogue",
    "automation_services",
    "farmers_market",
    "oncologist",
    "veterinarian",
    "home_goods_store",
    "e_cigarette_store",
    "marketing_consultant",
    "senior_citizen_services",
    "wholesaler",
    "commercial_industrial",
    "bicycle_shop",
    "motorcycle_repair",
    "public_utility_company",
    "auditorium",
    "medical_research_and_development",
    "skin_care",
    "architectural_tours",
    "salsa_club",
    "furniture_store",
    "pilates_studio",
    "caribbean_restaurant",
    "comic_books_store",
    "sunglasses_store",
    "dj_service",
    "hotel",
    "aquatic_pet_store",
    "orthopedist",
    "pharmaceutical_products_wholesaler",
    "auction_house",
    "theatre",
    "framing_store",
    "hotel_bar",
    "granite_supplier",
    "personal_chef",
    "pet_sitting",
    "medical_supply",
    "sports_club_and_league",
    "brazilian_restaurant",
    "cafe",
    "cupcake_shop",
    "delicatessen",
    "boxing_class",
    "portuguese_restaurant",
    "hostel",
    "food_delivery_service",
    "convenience_store",
    "drive_in_theater",
    "day_care_preschool",
    "automotive_wheel_polishing_service",
    "preschool",
    "photography_store_and_services",
    "botanical_garden",
    "gym",
    "bartending_school",
    "psychologist",
    "campus_building",
    "plastic_fabrication_company",
    "educational_services",
    "perfume_store",
    "religious_organization",
    "farm",
    "high_school",
    "legal_services",
    "jazz_and_blues",
    "bed_and_breakfast",
    "broadcasting_media_production",
    "pentecostal_church",
    "automotive_parts_and_accessories",
    "sports_wear",
    "machine_shop",
    "books_mags_music_and_video",
    "mexican_restaurant",
    "library",
    "bagel_shop",
    "tea_room",
    "colombian_restaurant",
    "burger_restaurant",
    "credit_and_debt_counseling",
    "real_estate",
    "freight_forwarding_agency",
    "comfort_food_restaurant",
    "passport_and_visa_services",
    "gastropub",
    "doctor",
    "thai_restaurant",
    "food_consultant",
    "meat_wholesaler",
    "toy_store",
    "winery",
    "paper_mill",
    "trusts",
    "arts_and_entertainment",
    "home_improvement_store",
    "beauty_product_supplier",
    "buffet_restaurant",
    "sports_and_recreation_venue",
    "vitamins_and_supplements",
    "food_stand",
    "restaurant_wholesale",
    "mediterranean_restaurant",
    "car_wash",
    "community_services_non_profits",
    "texmex_restaurant",
    "wheel_and_rim_repair",
    "cosmetic_and_beauty_supplies",
    "beauty_and_spa",
    "wildlife_sanctuary",
    "diner",
    "bridal_shop",
    "costa_rican_restaurant",
    "carpenter",
    "pizza_restaurant",
    "flea_market",
    "automotive_services_and_repair",
    "skate_park",
    "art_school",
    "podiatrist",
    "used_vintage_and_consignment",
    "coffee_shop",
    "taco_restaurant",
    "garbage_collection_service",
    "life_insurance",
    "monument",
    "business_manufacturing_and_supply",
    "middle_school",
    "sightseeing_tour_agency",
    "gymnastics_center",
    "brewery",
    "pet_groomer",
    "medical_spa",
    "ice_cream_and_frozen_yoghurt",
    "translating_and_interpreting_services",
    "donuts",
    "labor_union",
    "makeup_artist",
    "commercial_refrigeration",
    "sushi_restaurant",
    "auto_customization",
    "public_plaza",
    "theaters_and_performance_venues",
    "tax_law",
    "bail_bonds_service",
    "cards_and_stationery_store",
    "private_investigation",
    "computer_hardware_company",
    "hookah_bar",
    "hiking_trail",
    "hospital",
    "elevator_service",
    "real_estate_service",
    "campground",
    "industrial_equipment",
    "musical_instrument_store",
    "real_estate_investment",
    "event_planning",
    "sign_making",
    "media_news_company",
    "cinema",
    "property_management",
    "church_cathedral",
    "video_game_store",
    "jewelry_and_watches_manufacturer",
    "river",
    "topic_concert_venue",
    "tattoo_and_piercing",
    "fashion_accessories_store",
    "youth_organizations",
    "personal_assistant",
    "mobile_phone_store",
    "business",
    "hardware_store",
    "soccer_stadium",
    "peruvian_restaurant",
    "business_to_business",
    "laundromat",
    "sake_bar",
    "car_rental_agency",
    "periodontist",
    "ophthalmologist",
    "public_school",
    "law_enforcement",
    "chicken_restaurant",
    "media_agency",
    "tours",
    "reflexology",
    "accommodation",
    "music_venue",
    "bus_service",
    "art_gallery",
    "convents_and_monasteries",
    "nurse_practitioner",
    "embassy",
    "retail",
    "psychotherapist",
    "lounge",
    "discount_store",
    "caterer",
    "pub",
    "bookbinding",
    "luggage_store",
    "computer_store",
    "food",
    "evangelical_church",
    "electrician",
    "boutique",
    "theme_restaurant",
    "life_coach",
    "professional_services",
    "esports_team",
    "automotive_consultant",
    "public_service_and_government",
    "gay_bar",
    "divorce_and_family_law",
    "courier_and_delivery_services",
    "non_governmental_association",
    "installment_loans",
    "hat_shop",
    "specialty_grocery_store",
    "wills_trusts_and_probate",
    "investing",
    "online_shop",
    "auto_detailing",
    "educational_research_institute",
    "tobacco_shop",
    "movie_television_studio",
    "cooking_school",
    "eat_and_drink",
    "hvac_services",
    "bartender",
    "japanese_restaurant",
    "soul_food",
    "antique_store",
    "pet_adoption",
    "telecommunications",
    "home_security",
    "videographer",
    "home_and_garden",
    "bar_and_grill_restaurant",
    "office_equipment",
    "elementary_school",
    "internet_marketing_service",
    "jail_and_prison",
    "social_service_organizations",
    "police_department",
    "party_equipment_rental",
    "dog_trainer",
    "painting",
    "outlet_store",
    "pet_breeder",
    "sex_therapist",
    "french_restaurant",
    "currency_exchange",
    "surfing",
    "travel",
    "circus",
    "food_beverage_service_distribution",
    "avionics_shop",
    "audiologist",
    "immigration_law",
    "women's_health_clinic",
    "guest_house",
    "pest_control_service",
    "italian_restaurant",
    "department_of_motor_vehicles",
    "nursing_school",
    "building_supply_store",
    "art_museum",
    "korean_restaurant",
    "public_relations",
    "family_counselor",
    "shoe_store",
    "structural_engineer",
    "ice_cream_shop",
    "public_toilet",
    "career_counseling",
    "dermatologist",
    "water_park",
    "education",
    "self_storage_facility",
    "eye_care_clinic",
    "travel_services",
    "automotive_dealer",
    "used_car_dealer",
    "town_hall",
    "junkyard",
    "smoothie_juice_bar",
    "breakfast_and_brunch_restaurant",
    "kitchen_supply_store",
    "holiday_rental_home",
    "motorsports_store",
    "alcohol_and_drug_treatment_centers",
    "buddhist_temple",
    "packing_supply",
    "architectural_designer",
    "museum",
    "active_life",
    "performing_arts",
    "plastic_manufacturer",
    "computer_museum",
    "credit_union",
    "acupuncture",
    "bus_station",
    "pharmacy",
    "men's_clothing_store",
    "nature_reserve",
    "shipping_center",
    "commercial_vehicle_dealer",
    "martial_arts_club",
    "lawyer",
    "amusement_park",
    "nutritionist",
    "arts_and_crafts",
    "biotechnology_company",
    "fashion",
    "corporate_office",
    "pharmaceutical_companies",
    "massage",
    "comedy_club",
    "optometrist",
    "accountant",
    "german_restaurant",
    "parking",
    "barber",
    "service_apartments",
    "clothing_store",
    "political_organization",
    "metal_fabricator",
    "driving_school",
    "post_office",
    "contract_law",
    "fabric_wholesaler",
    "landmark_and_historical_building",
    "specialty_school",
    "hearing_aids",
    "laser_hair_removal",
    "employment_law",
    "bank_credit_union",
    "brokers",
    "restaurant",
    "bar",
    "masonry_concrete",
    "auto_restoration_services",
    "argentine_restaurant",
    "hair_salon",
    "trophy_shop",
    "financial_advising",
    "nursery_and_gardening",
    "fire_department",
    "internet_service_provider",
    "marketing_agency",
    "plumbing",
    "pets",
    "stadium_arena",
    "armed_forces_branch",
    "image_consultant",
    "sandwich_shop",
    "collection_agencies",
    "screen_printing_t_shirt_printing",
    "naturopathic_holistic",
    "movers",
    "advertising_agency",
    "beauty_salon",
    "women's_clothing_store",
    "latin_american_restaurant",
    "seafood_restaurant",
    "thrift_store",
    "fruits_and_vegetables",
    "water_treatment_equipment_and_services",
    "indian_restaurant",
    "computer_coaching",
    "retirement_home",
    "social_media_agency",
    "inventory_control_service",
    "hot_air_balloons_tour",
    "airport",
    "superstore",
    "computer_wholesaler",
    "canal",
    "wine_bar",
    "telecommunications_company",
    "b2b_jewelers",
    "bike_repair_maintenance",
    "bottled_water_company",
    "rental_services",
    "beer_bar",
    "park",
    "language_school",
    "outdoor_gear",
    "test_preparation",
    "rental_service",
    "vinyl_record_store",
    "event_photography",
    "massage_therapy",
    "physical_therapy",
    "private_school",
    "bike_rentals",
    "shopping_center",
    "business_equipment_and_supply",
    "furniture_assembly",
    "appliance_repair_service",
    "atms",
    "fitness_trainer",
    "metal_supplier",
    "engineering_services",
    "print_media",
    "sculpture_statue",
    "metals",
    "bingo_hall",
    "energy_equipment_and_solution",
    "history_museum",
    "ice_skating_rink",
    "laboratory_testing",
    "soccer_field",
    "sports_bar",
    "health_spa",
    "b2b_science_and_technology",
    "pet_services",
    "airport_shuttles",
    "school",
    "organic_grocery_store",
]
